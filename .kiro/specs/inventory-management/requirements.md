# 在庫管理システム要件定義書

## 概要

既存のLoaner Laptop予約システムに在庫管理機能を追加し、各サイトの機器在庫をリアルタイムで管理・表示できるシステムを構築する。これにより、ユーザーは利用可能な機器を確認しながら予約でき、管理者は効率的な在庫管理が可能になる。

## 用語集

- **在庫管理システム**: 各サイトの機器在庫数を管理し、予約システムと連携するシステム
- **予約システム**: 既存のLoaner Laptop予約フォームシステム
- **サイト**: 機器の受け取り場所（HND10、HND17、HND21）
- **機器**: 貸出対象の機器（Non-Amazon PC、Amazon PC、モニター）
- **利用可能在庫**: 現在予約可能な機器の数量
- **予約済み在庫**: 既に予約されている機器の数量
- **管理者**: 在庫管理権限を持つユーザー
- **一般ユーザー**: 機器を予約するユーザー
- **ITチーム**: 予約管理と在庫管理を行うチーム
- **通知システム**: メール送信とSlack通知を行うシステム
- **Alias**: ユーザーの社内識別子（メールアドレスの@マーク前の部分）
- **Alias検証**: 入力されたAliasが有効な社員のものかを確認する機能
- **Midway認証**: Amazon社内の統合認証システム
- **認証済みユーザー**: Midway認証を通過し、身元が確認されたユーザー
- **サイト担当者**: 各サイトで機器の準備・受渡しを担当するITチームメンバー
- **担当者管理**: サイトごとの担当者情報を管理する機能
- **設置完了**: 担当者が機器の準備・設置を完了した状態
- **Doneボタン**: 担当者が設置完了を報告するためのボタン機能
- **予約者Slack通知**: 予約者個人のSlackアカウントに送信される設置完了通知
- **返却確認**: 予約者が機器を返却したことを報告する機能
- **在庫復旧**: 返却された機器を利用可能在庫に戻す処理
- **返却遅延通知**: 返却期限を過ぎた予約に対する自動通知機能
- **返却確認**: 予約者が機器を返却したことを報告する機能
- **在庫復旧**: 返却された機器を再び貸出可能な在庫として登録する処理
- **返却遅延**: 予定返却日を過ぎても返却されていない状態

## 要件

### 要件1

**ユーザーストーリー:** 一般ユーザーとして、希望する機器と期間で予約したい。在庫が不足している場合は、システムが自動的に最適な代替案を提案してほしい。

#### 受入基準

1. WHEN ユーザーが機器と期間を選択する THEN システムは在庫状況を内部で確認し、予約可能性を判定する
2. WHEN 希望する条件で在庫が不足している THEN システムは利用可能な代替案を自動的に提案する
3. WHEN 代替案を提案する THEN システムは他のサイトや近い期間での利用可能性を表示する
4. WHEN 全てのサイトで在庫が不足している THEN システムは最も早く利用可能になる日程を提案する
5. WHEN ユーザーが代替案を選択する THEN システムは選択された条件で予約を進行する

### 要件2

**ユーザーストーリー:** 管理者として、各サイトの機器在庫を管理したい。そうすることで、適切な在庫レベルを維持し、効率的な機器配置ができる。

#### 受入基準

1. WHEN 管理者が在庫管理画面にアクセスする THEN システムは全サイトの在庫状況を表示する
2. WHEN 管理者が機器の在庫数を更新する THEN システムは新しい在庫数を保存し、予約システムに反映する
3. WHEN 管理者が新しい機器を追加する THEN システムは機器情報と初期在庫数を登録する
4. WHEN 管理者が機器をメンテナンス状態に設定する THEN システムは該当機器を予約対象から除外する
5. WHEN 管理者が予約状況を確認する THEN システムは各機器の予約スケジュールを表示する

### 要件3

**ユーザーストーリー:** システム管理者として、予約と在庫の整合性を保ちたい。そうすることで、ダブルブッキングや在庫不足による問題を防げる。

#### 受入基準

1. WHEN ユーザーが予約を確定する THEN システムは在庫数を減算し、予約期間中の利用可能在庫を更新する
2. WHEN 予約がキャンセルされる THEN システムは在庫数を復元し、利用可能在庫を更新する
3. WHEN 同時に複数のユーザーが同じ機器を予約しようとする THEN システムは在庫の整合性を保ち、先着順で処理する
4. WHEN 在庫数が負の値になろうとする THEN システムは予約を拒否し、エラーメッセージを表示する
5. WHEN システムが在庫データを更新する THEN システムは変更履歴を記録し、監査証跡を保持する

### 要件4

**ユーザーストーリー:** ITチーム管理者として、システム全体の予約状況と在庫状況を把握したい。そうすることで、適切な在庫配置と予約管理ができる。

#### 受入基準

1. WHEN 管理者がダッシュボードにアクセスする THEN システムは全サイトの予約状況をカレンダー形式で表示する
2. WHEN 管理者が特定の期間を選択する THEN システムはその期間の詳細な在庫利用状況を表示する
3. WHEN 管理者が機器タイプでフィルタリングする THEN システムは指定された機器タイプの予約状況のみを表示する
4. WHEN 在庫不足が予想される期間がある THEN システムは事前に警告を表示し、対策を提案する
5. WHEN 管理者が予約の詳細を確認する THEN システムは予約者情報と機器利用状況を表示する

### 要件5

**ユーザーストーリー:** システム運用者として、在庫データの正確性を保証したい。そうすることで、信頼性の高い予約システムを提供できる。

#### 受入基準

1. WHEN システムが在庫データを処理する THEN システムは全ての在庫変更をトランザクション内で実行する
2. WHEN データベース接続エラーが発生する THEN システムは適切なエラーハンドリングを行い、データの整合性を保つ
3. WHEN 在庫データが破損する THEN システムはバックアップから復旧し、データの一貫性を確保する
4. WHEN 大量の同時アクセスがある THEN システムは適切な排他制御を行い、データ競合を防ぐ
5. WHEN 在庫データの不整合が検出される THEN システムは管理者に通知し、自動修正を試行する

### 要件6

**ユーザーストーリー:** 予約者として、予約完了時に確認メールを受け取りたい。そうすることで、予約内容を確認し、安心して利用日を迎えられる。

#### 受入基準

1. WHEN ユーザーが予約を完了する THEN システムは予約者のメールアドレスに予約確認メールを送信する
2. WHEN 予約確認メールを送信する THEN システムは予約詳細（機器、期間、サイト、予約ID）を含める
3. WHEN メール送信が失敗する THEN システムは最大3回まで再送を試行する
4. WHEN メール再送も失敗する THEN システムはITチームに送信失敗をSlack通知し、手動での連絡を依頼する
5. WHEN メールボックス満杯などの永続的エラーが発生する THEN システムは予約完了画面に予約詳細を表示し、印刷・保存を促す
6. WHEN 予約内容が変更される THEN システムは更新された内容で新しい確認メールを送信する
7. WHEN 予約がキャンセルされる THEN システムはキャンセル確認メールを予約者に送信する

### 要件7

**ユーザーストーリー:** ITチームメンバーとして、新しい予約が入った時点で通知を受け取りたい。そうすることで、迅速に予約対応と機器準備ができる。

#### 受入基準

1. WHEN 新しい予約が完了する THEN システムはITチーム用Slackチャンネルに予約通知を送信する
2. WHEN 予約通知を送信する THEN システムは予約者情報、機器詳細、受取サイト、期間を含める
3. WHEN 予約がキャンセルされる THEN システムはキャンセル通知をSlackに送信する
4. WHEN 予約内容が変更される THEN システムは変更内容をSlackに通知する
5. WHEN Slack通知の送信が失敗する THEN システムは代替手段（メール）で管理者に通知する

### 要件8

**ユーザーストーリー:** サイト担当者として、担当サイトの機器受取前日にリマインダーを受け取りたい。そうすることで、機器準備の漏れを防ぎ、スムーズな受渡しができる。

#### 受入基準

1. WHEN 予約開始日の前日になる THEN システムは該当サイトの担当者にリマインダーをSlackで送信する
2. WHEN リマインダーを送信する THEN システムは予約者情報、機器リスト、受取サイト、翌日の予定を含める
3. WHEN 複数の予約が同じサイトで翌日に開始される THEN システムは該当サイト担当者に全ての予約をまとめて送信する
4. WHEN サイト担当者が設定されていない THEN システムは全ITチーム共通チャンネルにリマインダーを送信し、該当サイトの担当者を@メンションで指名する
5. WHEN リマインダー送信が失敗する THEN システムは管理者にメールで通知し、手動対応を促す
6. WHEN 予約がキャンセルされた場合 THEN システムは該当予約をリマインダー対象から除外する

### 要件9

**ユーザーストーリー:** 予約者として、メール送信に問題がある場合でも予約内容を確認できる手段がほしい。そうすることで、確実に予約情報を保持できる。

#### 受入基準

1. WHEN 予約が完了する THEN システムは予約完了画面に詳細な予約情報を表示する
2. WHEN 予約完了画面を表示する THEN システムは印刷ボタンとPDF保存ボタンを提供する
3. WHEN メール送信が失敗する THEN システムは予約完了画面に「メール送信に失敗しました。この画面を保存してください」と表示する
4. WHEN ユーザーが予約確認を再表示したい THEN システムは予約IDによる検索機能を提供する
5. WHEN 予約ID検索を行う THEN システムは予約詳細を表示し、再印刷・再保存を可能にする

### 要件10

**ユーザーストーリー:** 予約者として、安全かつ確実にAliasを入力したい。理想的にはMidway認証を通じて自動入力されることで、入力ミスを防ぎたい。

#### 受入基準（理想実装：Midway認証利用可能な場合）

1. WHEN ユーザーが予約システムにアクセスする THEN システムはMidway認証を要求する
2. WHEN Midway認証が成功する THEN システムは認証済みのAliasを自動的にAlias入力欄に設定する
3. WHEN 認証済みAliasが設定される THEN システムはAlias入力欄を読み取り専用にし、手動変更を防ぐ
4. WHEN Midway認証が失敗する THEN システムは認証エラーメッセージを表示し、再認証を促す
5. WHEN 認証セッションが期限切れになる THEN システムは自動的に再認証を要求し、予約データを保持する

#### 受入基準（代替実装：Midway認証利用不可能な場合）

6. WHEN Midway認証が実装できない THEN システムは手動Alias入力とリアルタイム検証を提供する
7. WHEN ユーザーがAliasを入力する THEN システムは入力形式の妥当性を即座に検証する
8. WHEN 入力されたAliasが社内ディレクトリに存在しない THEN システムは警告メッセージを表示し、再入力を促す
9. WHEN Aliasの検証ができない場合 THEN システムは予約を一時保留し、ITチームに確認を依頼する
10. WHEN 間違ったAliasで予約が完了してしまった場合 THEN システムはITチームに不正Alias通知をSlackで送信する

### 要件11

**ユーザーストーリー:** システム管理者として、不正利用を防ぎ、システムのセキュリティと信頼性を保ちたい。理想的にはMidway認証で、代替案では適切な検証機能で対応したい。

#### 受入基準（理想実装：Midway認証利用可能な場合）

1. WHEN 未認証ユーザーが予約システムにアクセスしようとする THEN システムは自動的にMidway認証画面にリダイレクトする
2. WHEN 認証に失敗したユーザーがアクセスを試行する THEN システムはアクセスを拒否し、適切なエラーメッセージを表示する
3. WHEN 認証済みユーザーのセッションが無効になる THEN システムは現在の入力内容を一時保存し、再認証後に復元する

#### 受入基準（代替実装：Midway認証利用不可能な場合）

4. WHEN Midway認証が実装できない THEN システムは社内ネットワークからのアクセス制限を実装する
5. WHEN 不正なAlias入力が検出される THEN システムはアクセスログに記録し、ITチームに通知する
6. WHEN 短時間に大量の予約試行がある THEN システムはレート制限を適用し、不正利用を防ぐ

#### 受入基準（共通）

7. WHEN 不正なアクセス試行が検出される THEN システムはセキュリティログに記録し、管理者に通知する
8. WHEN 認証システムに障害が発生する THEN システムは適切なエラーページを表示し、復旧時刻の目安を提供する

### 要件12

**ユーザーストーリー:** ITチーム管理者として、各サイトの担当者を管理したい。そうすることで、適切な担当者に機器準備のリマインダーを送信できる。

#### 受入基準

1. WHEN 管理者が担当者管理画面にアクセスする THEN システムは各サイトの現在の担当者一覧を表示する
2. WHEN 管理者がサイト担当者を追加する THEN システムは担当者のSlackユーザーIDまたはメールアドレスを登録する
3. WHEN 管理者がサイト担当者を変更する THEN システムは新しい担当者情報を保存し、次回のリマインダーから適用する
4. WHEN 管理者が担当者を削除する THEN システムは該当担当者を削除し、代替通知先を設定する
5. WHEN サイトに複数の担当者が設定されている THEN システムは全ての担当者にリマインダーを送信する
6. WHEN 担当者のSlack情報が無効になる THEN システムは送信失敗を検出し、管理者に通知する
7. WHEN 共通チャンネルにリマインダーを送信する THEN システムは該当サイトの担当者全員を@メンションで指名する
8. WHEN 担当者が複数設定されている THEN システムは全ての担当者を@メンションに含める
9. WHEN 担当者のSlackユーザーIDが取得できない THEN システムは担当者名をテキストで表示し、管理者に設定確認を促す
10. WHEN 管理者が予約者のSlackアカウントを管理する THEN システムはAliasとSlackユーザーIDの紐付け機能を提供する
11. WHEN 予約者のSlackアカウントが未設定の場合 THEN システムは自動的にAlias@company.slackでの検索を試行する
12. WHEN Slackアカウントの自動検索が失敗する THEN システムは管理者に手動設定を促し、メール通知のみを使用する

### 要件13

**ユーザーストーリー:** サイト担当者として、機器の設置完了を簡単に報告したい。そうすることで、予約者に迅速に利用開始を知らせることができる。

#### 受入基準

1. WHEN 担当者がリマインダーを受信する THEN システムはSlackメッセージに「設置完了」ボタンを含める
2. WHEN 担当者が「設置完了」ボタンを押す THEN システムは設置完了状態を記録し、予約者に通知を送信する
3. WHEN 設置完了通知を送信する THEN システムは予約者のメールアドレスに「機器の準備が完了しました」メールを送信する
4. WHEN 設置完了メールを送信する THEN システムは受取サイト、機器リスト、受取可能時間を含める
5. WHEN 複数の予約がある場合 THEN システムは個別に設置完了ボタンを提供し、それぞれ独立して処理する
6. WHEN 設置完了ボタンが押された後 THEN システムはボタンを無効化し、「完了済み」と表示する

### 要件14

**ユーザーストーリー:** 予約者として、機器の準備完了を迅速に知りたい。そうすることで、適切なタイミングで機器を受け取りに行ける。

#### 受入基準

1. WHEN 担当者が設置完了を報告する THEN システムは予約者にメールとSlackの両方で即座に設置完了通知を送信する
2. WHEN 設置完了通知を送信する THEN システムは受取場所の詳細情報と営業時間を含める
3. WHEN Slack通知を送信する THEN システムは予約者のSlackアカウントにDMで設置完了メッセージを送信する
4. WHEN 予約者のSlackアカウントが特定できない THEN システムはメール通知のみを送信し、管理者にSlack設定の確認を依頼する
5. WHEN メール送信が失敗する THEN システムはSlack通知を優先し、予約完了画面の予約ID検索で設置状況を確認可能にする
6. WHEN Slack通知が失敗する THEN システムはメール通知を優先し、ITチームに通知失敗を報告する
7. WHEN 予約者が設置状況を確認する THEN システムは「準備中」「設置完了」「受取済み」のステータスを表示する

### 要件15

**ユーザーストーリー:** ITチーム管理者として、各予約の設置状況を把握したい。そうすることで、進捗管理と問題の早期発見ができる。

#### 受入基準

1. WHEN 管理者がダッシュボードにアクセスする THEN システムは各予約の設置ステータスを表示する
2. WHEN 設置完了が遅れている予約がある THEN システムは遅延アラートを表示し、担当者に再通知を提案する
3. WHEN 管理者が設置ステータスを手動更新する THEN システムは変更を記録し、関係者に通知する
4. WHEN 設置完了の統計を確認する THEN システムは平均設置時間とサイト別の完了率を表示する
5. WHEN 問題のある予約を特定する THEN システムは設置遅延の原因分析データを提供する

### 要件16

**ユーザーストーリー:** 予約者として、機器を返却した際に簡単に返却報告をしたい。そうすることで、返却手続きを完了し、他の人が機器を利用できるようにしたい。

#### 受入基準

1. WHEN 予約期間が開始される THEN システムは予約者に返却方法と返却報告手順をSlackとメールで通知する
2. WHEN 予約者が返却報告をする THEN システムはSlackで「返却済み」ボタンを提供する
3. WHEN 予約者が「返却済み」ボタンを押す THEN システムは返却確認を記録し、在庫を即座に復旧する
4. WHEN 在庫が復旧される THEN システムは該当機器を利用可能在庫として更新し、新規予約を受付可能にする
5. WHEN 返却が完了する THEN システムは予約者に返却完了確認をSlackとメールで送信する
6. WHEN 返却完了確認を送信する THEN システムは利用期間と返却日時を含める

### 要件17

**ユーザーストーリー:** 予約者として、返却期限を忘れないようにリマインダーを受け取りたい。返却が遅れた場合は適切に対応したい。

#### 受入基準

1. WHEN 返却予定日の3日前になる THEN システムは予約者に返却リマインダーをSlackとメールで送信する
2. WHEN 返却予定日の1日前になる THEN システムは予約者に最終リマインダーを送信し、「返却済み」ボタンを含める
3. WHEN 返却予定日を過ぎても返却されない THEN システムは毎日返却催促通知を予約者に送信する
4. WHEN 返却催促通知を送信する THEN システムは遅延日数と返却の重要性を強調したメッセージを含める
5. WHEN 返却が7日以上遅延する THEN システムはITチームに遅延アラートを送信し、直接連絡を促す
6. WHEN 返却催促が継続される THEN システムは毎回「返却済み」ボタンを含め、簡単に報告できるようにする

### 要件18

**ユーザーストーリー:** ITチーム管理者として、返却状況と在庫の動きを把握したい。そうすることで、適切な在庫管理と遅延対応ができる。

#### 受入基準

1. WHEN 管理者がダッシュボードにアクセスする THEN システムは返却予定、返却済み、遅延中の予約一覧を表示する
2. WHEN 返却遅延が発生している THEN システムは遅延日数と予約者情報をハイライト表示する
3. WHEN 管理者が返却状況を手動更新する THEN システムは在庫を復旧し、変更履歴を記録する
4. WHEN 在庫復旧が実行される THEN システムは復旧した機器数と利用可能在庫数を更新表示する
5. WHEN 返却統計を確認する THEN システムは平均利用期間、遅延率、サイト別返却状況を表示する
6. WHEN 長期遅延者を特定する THEN システムは遅延履歴と対応状況を管理者に提供する